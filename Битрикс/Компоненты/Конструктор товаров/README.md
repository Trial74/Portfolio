## Конструктор товаров (Bitrix)

Компонент реализует многошаговый конструктор товаров MIXON на базе стандартного компонента `bitrix:catalog.section.list`. Пользователь по шагам выбирает базовый товар, его параметры (объём, цвет, аромат, геометрию и тираж), дополнительные услуги (дизайн, упаковку, юр.‑сопровождение и т.п.), формирует корзину и оформляет заказ. Вся бизнес‑логика корзины и оформления заказа работает через стандартные классы `Bitrix\Sale`, highload‑блоки и 1С‑каталог.

### Основная идея работы

- **Публичная страница** (`public/index.php`): подключает `bitrix:catalog.section.list` с нужными параметрами (ID инфоблока, секции, глубина, кэш и т.д.), а главное — передаёт в шаблон:
  - **структуру ID DOM‑элементов** (`IDS`) для всех шагов и блоков конструктора;
  - **описание торговых предложений** (`SKU_PROPS`) — какие свойства SKU участвуют в подборе (объём, цвет, аромат и т.п.);
  - **настройки оформления заказа** (`ORDER`) — доступные способы доставки и оплаты с их ID и картинками.
- **Шаблон компонента** (папка `component/catalog.section.list`) строит многошаговый интерфейс конструктора на фронтенде и передаёт все данные в JS‑класс `JCProductConstructor`.
- **AJAX‑обработчик** (`public/axax/constructor-ajax.php`) отвечает за:
  - выборку доступных товаров и их SKU;
  - расчёт цен с учётом тиража и свойств;
  - работу с корзиной (добавление/удаление/пересчёт);
  - создание заказа и синхронизацию с Битрикс24.

### Структура файлов

- **`public/index.php`**
  - Точка входа для пользователя.
  - Подключает пролог/эпилог Bitrix.
  - Включает компонент `bitrix:catalog.section.list` с шаблоном `.default` или `mobile` в зависимости от константы `VERSION`.
  - Передаёт в компонент параметры:
    - `IBLOCK_ID = 124` и другие настройки выборки;
    - массив `IDS` с ID всех ключевых DOM‑элементов (шаги, кнопки, блоки цен, корзина, форма заказа и т.д.);
    - `SKU_PROPS` — список кодов и имён свойств торговых предложений;
    - `ORDER` — конфигурация доставки и оплаты (ID служб / платёжных систем и пути к изображениям).

- **`public/axax/constructor-ajax.php`**
  - Подключает «облегчённый» пролог Bitrix, отключает статистику и отдаёт **JSON**.
  - Использует классы:
    - ядро (`Bitrix\Main`, `Context`, `Option`, `Event` и др.),
    - `Bitrix\Sale\Basket`, `Order`, `Delivery`, `PaySystem`,
    - ORM‑класс `Bitrix\Iblock\Elements\ElementCatalogMixonTable`,
    - Highload‑блоки (`Bitrix\Highloadblock`),
    - `CurrencyManager` и др.
  - Обрабатывает POST‑запросы по AJAX (параметр `action`):
    - `selectItems` — выбирает товары по разделу, подтягивает SKU через `CCatalogSKU::getOffersList`, собирает свойства, картинки (в т.ч. иконки ароматов из HL‑блока) и считает цену через `priceByConstructorMixon`.
    - `selectServices` — подбирает дополнительные услуги по разделу и считает для них цену.
    - `getBasket` — возвращает текущее состояние корзины (обёртка над `Bitrix\Sale\Basket`).
    - `addToBasket` — валидирует входные данные, формирует свойства позиции (выбранные параметры, услуги, тираж, название товара), добавляет/перезаписывает позицию в корзине, синхронизирует связанные услуги и возвращает актуальную корзину.
    - `delItemToBasket` — удаляет товар и связанные с ним услуги из корзины.
    - `createOrder` — создаёт заказ в `Bitrix\Sale\Order` на основе корзины и данных формы (ФИО, регион, адрес, телефон, email, доставка, оплата), записывает свойства заказа и:
      - создаёт/находит пользователя (по email);
      - формирует отгрузку и оплату;
      - создаёт сделку/контакт в Битрикс24 через `webhooks_B24/class.php`.
  - Во всех случаях отвечает структурой:
    - `error` — флаг ошибки,
    - `errorMessage` — текст ошибки,
    - `result` — полезные данные (товары, услуги, корзина, номер заказа и т.д.).

- **`component/catalog.section.list/.default`**
  - **`template.php`**
    - Полноэкранный **десктопный шаблон** конструктора.
    - Загружает настройки из HL‑блока (ID=13) и инициализирует массив текстов шагов (`$MESSAGES`).
    - Формирует многошаговый интерфейс:
      - шаг выбора раздела и товара;
      - шаг детального выбора параметров товара (объём, цвет, аромат, геометрия, тираж);
      - шаги выбора услуг (дизайн, упаковка, юр.услуги и пр.);
      - шаг корзины и подтверждения заказа;
      - форма ввода контактных данных и выбора доставки/оплаты.
    - Для всех блоков использует ID из массива `IDS`, чтобы JS‑логика могла управлять состоянием (показывать/скрывать шаги, обновлять цену, корзину и т.д.).
    - Подключает стили и скрипты скроллбара (`mCustomScrollbar`) и инициализирует JS‑класс:
      - `JCProductConstructor( $jsParams )`, где в `jsParams` передаются `ids`, `mess`, `circulations`, `skuprops`, `arResult`, `arParams`, `settings`, `template_path`.
  - **`style.css`**
    - Оформление десктопного конструктора:
      - сетка из левого (шаги) и правого (цена, шаги, корзина, заказ) блоков;
      - оформление кнопок шагов, карточек товаров и услуг;
      - стили заголовков, подсказок, форм и скролл‑областей.
  - **`script.js`**
    - Клиентская логика (поверхностно):
      - инициализация `JCProductConstructor`;
      - обработка кликов по шагам, кнопкам, выбору параметров и услуг;
      - ajax‑взаимодействие с `constructor-ajax.php` (подбор товаров/услуг, обновление цен, корзины, создание заказа).
  - **`result_modifier.php`**
    - Подготовка данных для шаблона (агрегация/нормализация данных `arResult` и параметров компонента перед выводом шаблона).
  - **`lang/ru/template.php`**
    - Языковые константы интерфейса конструктора (`Loc::getMessage(...)`): заголовки шагов, подписи кнопок, подсказки и т.д.
  - **`mCustomScrollbar/*`**
    - Подключаемые CSS/JS плагины кастомного скроллбара.

- **`component/catalog.section.list/mobile`**
  - **`template.php`**
    - Адаптированный **мобильный шаблон** с аккордеонами шагов.
    - Логика та же, что и в `.default`, но:
      - интерфейс выстроен вертикально в виде шагов‑секций;
      - кнопки перехода между шагами (`m_s_1` … `m_s_6`) и корзина/оформление заказа выглядят иначе, с учётом мобильного UX.
    - Также инициализирует `JCProductConstructor` и использует те же массивы настроек/сообщений.
  - **`style.css`**
    - Стили мобильного конструктора: вертикальная компоновка, крупные кликабельные области, адаптивное отображение корзины и формы заказа.
  - **`script.js`**
    - JS‑логика мобильного поведения: переключение аккордеонов, скролл, ajax‑запросы к `constructor-ajax.php`.
  - **`jq_ui/*`**
    - Дополнительные js/css для отдельных элементов интерфейса (слайдеры, контролы и т.п.).
  - **`mCustomScrollbar/*`**
    - Плагины скроллбара для мобильного шаблона.
  - **`lang/ru/template.php`**
    - Локализации, используемые в мобильном шаблоне.

### Краткий сценарий работы пользователя

1. Пользователь открывает страницу `public/index.php`, где в зависимости от устройства подключается десктопный или мобильный шаблон конструктора.
2. Шаблон инициализирует `JCProductConstructor` и подгружает стартовые данные (список разделов/товаров, настройки, тексты шагов).
3. На каждом шаге пользователь:
   - выбирает товар и его параметры (объём, аромат, цвет, геометрию, тираж);
   - добавляет дополнительные услуги;
   - контролирует итоговую цену и состав корзины.
4. Все действия (выбор SKU, пересчёт цены, манипуляции с корзиной) выполняются асинхронно через AJAX‑скрипт `constructor-ajax.php`.
5. На заключительном шаге пользователь заполняет форму (ФИО, контакты, адрес, регион), выбирает доставку и оплату.
6. После отправки формы создаётся заказ в Bitrix, данные передаются в Битрикс24, а пользователь получает сообщение об успешном оформлении заказа.

### Скриншоты работы компонента

- **Шаг 1 — выбор раздела и товара**

  ![Шаг 1 — выбор товара](./product_constructor_0.JPG)

- **Шаг 2 — выбор параметров товара**

  ![Шаг 2 — параметры товара](./product_constructor_1.JPG)

- **Шаг 3 — выбор услуг (дизайн)**

  ![Шаг 3 — услуги дизайн](./product_constructor_2.JPG)

- **Шаг 4 — выбор услуг (упаковка)**

  ![Шаг 4 — услуги упаковка](./product_constructor_3.JPG)

- **Шаг 5 — выбор услуг (юридическое сопровождение)**

  ![Шаг 5 — услуги юр. сопровождение](./product_constructor_4.JPG)

- **Шаг 6 — корзина**

  ![Шаг 6 — корзина](./product_constructor_5.JPG)

- **Шаг 7 — оформление заказа**

  ![Шаг 7 — оформление заказа](./product_constructor_6.JPG)
